# Maintainer: Arch Linux Pro Audio <dev@archaudio.org>
# Contributor: SpepS <dreamspepser at yahoo dot it>
# Contributor: Bernardo Barros <bernardobarros@gmail.com>

pkgname=csound
pkgver=5.13.0
pkgrel=1
pkgdesc="A sound and music synthesis system, providing facilities for composition and performance over a wide range of platforms."
arch=('i686' 'x86_64')
url="http://csound.sourceforge.net/"
license=('GPL')
depends=('fltk' 'fluidsynth' 'liblo' 'perl' 'portaudio' 'portmidi' 'tk')
makedepends=('scons')
optdepends=('qutecsound: qt frontend'
            'cecilia: tcl/tk frontend')
provides=('csound5')
conflicts=('csound5' 'csound5-cvs' 'csound5.12-cvs' 'csound-cvs' 'csound-cecilia')
install="$pkgname.install"
source=("http://sourceforge.net/projects/csound/files/csound5/csound5.13/Csound5.13.0.tar.gz")
md5sums=('6c123822e3396f136d6eeea0f801a495')

_csOptions="gcc4opt=native usePortAudio=1 usePortMIDI=1 buildCsound5GUI=1 useOSC=1 buildPythonOpcodes=1 buildInterfaces=1 buildVirtual=1 dynamicCsoundLibrary=1 buildJavaWrapper=1 useDouble=1"

_csoundOptions="gcc4opt=native useCoreAudio=0 buildCsound5GUI=1 useOSC=1 dynamicCSoundLibrary=1 buildPythonOpcodes=1 buildVirtual=1 buildInterfaces=1 buildPythonWrapper=1 buildJavaWrapper=1 buildCSEditor=1 buildNewParser=0 tclversion=8.5 buildRelease=1 buildStkOpcodes=1 buildTclcsound=1 buildLuaWrapper=1 buildCsoundAC=1 useDouble=1"

 case $CARCH in
   'i686')
     _gccOptions="-O2 -march=i686 -mtune=generic -pipe" ;;
   'x86_64')
     _gccOptions="-O2 -march=x86-64 -mtune=generic -pipe" ;;
 esac

build() {
  cd "$srcdir/Csound$pkgver"

  # Removing ldconfig
  sed -i "483,484d" install.py
  sed -i "s_/fltk-1.1__" custom.py

  # sed -i "s_mtune_march_g;762,764d;2366,2367d" SConstruct

  sed \
	-e "s_\(env python\).*_\12_" \
	-e "s_\(bin/python\).*_\12_" \
	-i `grep -rlE "(env python|bin/python)" .`

  scons customCFLAGS="$_gccOptions" $_csOptions
}

package() {
  cd "$srcdir/Csound$pkgver"

  python2 install.py --prefix="$pkgdir/usr" \

  # Deleting unneeded files
  rm "$pkgdir"/usr/bin/uninstall-csound5
  rm "$pkgdir"/usr/*.md5sums
}
